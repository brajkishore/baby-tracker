# Baby Tracker (Flutter, Android-first)

Baby Tracker is an Android-priority Flutter app that continuously monitors safety signals, stores them offline, and syncs them in priority order when network becomes available.

## Features implemented

- Background signal tracking:
  - GPS (lat/lng/accuracy/speed)
  - Battery % + charging state
  - Network online/offline via `connectivity_plus`
  - Screen ON/OFF via Android platform channel broadcast receiver
  - Motion and possible anomalies (`motion change`, `sudden jerk/drop` hooks)
  - Geofence enter/exit via `flutter_background_geolocation`
  - Tamper events (GPS disabled / permission revoked)
  - Heartbeat event every minute
- Offline queue using Hive local storage.
- Priority sync engine (HIGH → MEDIUM → LOW) to `POST /api/v1/device-signals`.
- WorkManager periodic background sync.
- Headless + start-on-boot background geolocation configuration.
- UI: Home status dashboard, Logs with priority filter, Settings and permission state.

## Event schema

Each signal writes a full event snapshot with:

- `event_id`
- `device_id`
- `event_type`
- `priority`
- `timestamp`
- `lat`
- `lng`
- `battery_pct`
- `is_charging`
- `network_type`
- `screen_state`
- `motion_state`
- `speed`
- `confidence`
- `value`
- `synced`

## Event types

### NORMAL
- `HEARTBEAT`
- `LOCATION_UPDATE`
- `BATTERY_STATUS`
- `NETWORK_STATUS`
- `SCREEN_STATE`
- `MOTION_STATE`

### ANOMALY
- `GEOFENCE_EXIT`
- `BATTERY_LOW`
- `NETWORK_LOST`
- `GPS_DISABLED`
- `PERMISSION_REVOKED`
- `APP_HEARTBEAT_MISSED` (hook available, can be generated by backend watchdog)
- `SCREEN_OFF_MOVING`
- `MOTION_SUDDEN_JERK`
- `MOTION_POSSIBLE_DROP`

## Setup

1. Install Flutter SDK (3.22+ recommended) and Android Studio.
2. Run:
   ```bash
   flutter pub get
   ```
3. Update API base URL in `lib/main.dart`:
   ```dart
   const apiBaseUrl = 'https://replace-me.example.com';
   ```
4. For Android release with `flutter_background_geolocation`, configure production license in Android manifest / gradle as per plugin docs. Debug builds run without release license.

## Permissions

Declared in AndroidManifest:
- `ACCESS_FINE_LOCATION`
- `ACCESS_BACKGROUND_LOCATION`
- `FOREGROUND_SERVICE`
- `INTERNET`
- `RECEIVE_BOOT_COMPLETED`
- plus `POST_NOTIFICATIONS`, `WAKE_LOCK`, `FOREGROUND_SERVICE_LOCATION`.

Runtime permission flow is on Settings screen. If denied, rationale warning is shown.

## WorkManager + background behavior

- Periodic sync registered with `workmanager`.
- Android minimum periodic interval is 15 minutes in production scheduler behavior.
- Connectivity listener triggers immediate foreground sync when network resumes.
- Background geolocation config uses:
  - `stopOnTerminate: false`
  - `startOnBoot: true`
  - `enableHeadless: true`
  - `foregroundService: true`

## Android battery optimization exceptions

To improve reliability on OEM devices:

1. Open Android settings → Apps → Baby Tracker → Battery.
2. Set to **Unrestricted** (or disable optimization for app).
3. On some vendors also whitelist Auto Start and lock app in recents.
4. "Safari for Android power management exceptions": if your team refers to an MDM policy/profile under this name, ensure Baby Tracker is excluded from aggressive background kill rules.

## Testing on physical Android device

1. Connect device with developer mode enabled.
2. Install:
   ```bash
   flutter run
   ```
3. Grant location permissions:
   - While using app
   - Allow all the time (background)
4. Disable battery optimization for app (recommended).
5. Test scenarios:
   - Move device to produce location + motion updates.
   - Toggle Wi-Fi/mobile data off/on to observe `NETWORK_LOST` then sync on reconnect.
   - Turn screen off while moving to produce `SCREEN_OFF_MOVING`.
   - Disable GPS from system quick settings to produce `GPS_DISABLED`.
   - Exit configured geofence to generate `GEOFENCE_EXIT`.
6. Verify logs on Logs tab and backend API receipts.

## Build release

```bash
flutter build apk --release
```

Then apply plugin license + signing config before production deployment.
